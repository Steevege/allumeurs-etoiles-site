---
import Layout from '../layouts/Layout.astro';
import Icon from '../components/Icon.astro';
import { getCollection } from 'astro:content';

// Récupérer les spectacles actifs
const spectacles = (await getCollection('spectacles'))
  .filter(s => s.data.active)
  .sort((a, b) => a.data.order - b.data.order)
  .slice(0, 3);

// URL Google Sheets pour les événements (chargés côté client)
const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS3-HCSDkdEewDoHs6gbNh2Nvml9XWR4K_D615oT8HhDii3O6vVn_978i8K9PZWY-Wr1hD1yr8YqlNq/pub?output=csv';

// Récupérer l'actualité mise en avant
const featuredNews = (await getCollection('news'))
  .filter(n => n.data.featured)
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime())[0];
---

<Layout title="Accueil" description="Des spectacles musicaux et théâtraux qui ont pour but d'émouvoir et de faire réfléchir sur le sens du monde et de la vie. Des spectacles à écouter et regarder avec son coeur.">
  <!-- Hero Section -->
  <section class="hero cosmic-pattern">
    <div class="hero-content">
      <h1>Des spectacles plein le coeur !</h1>
      <p class="hero-subtitle">
        Des spectacles musicaux et théâtraux qui ont pour but d'émouvoir<br />
        et de faire réfléchir sur le sens du monde et de la vie
      </p>
      <div class="hero-cta">
        <a href="/spectacles" class="btn btn-primary">Découvrir nos spectacles</a>
        <a href="/contact" class="btn btn-secondary">Nous contacter</a>
      </div>
    </div>
  </section>

  <!-- Actualité mise en avant (éditable CMS) -->
  {featuredNews && (
    <section class="news-featured">
      <div class="container">
        <div class="news-card">
          <div class="news-icon"><Icon name="sparkle" size={32} /></div>
          <div class="news-content">
            <h2>{featuredNews.data.title}</h2>
            <p class="news-date">
              {featuredNews.data.date.toLocaleDateString('fr-FR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
              })}
            </p>
            <p>{featuredNews.data.excerpt}</p>
            <a href={`/blog/${featuredNews.slug}`} class="btn-link">Lire la suite →</a>
          </div>
        </div>
      </div>
    </section>
  )}

  <!-- Spectacles phares -->
  <section class="spectacles-section">
    <div class="container">
      <h2 class="section-title">Nos Spectacles</h2>
      <p class="section-subtitle">Des spectacles à écouter et regarder avec son coeur, pour tous les âges</p>

      <div class="spectacles-grid">
        {spectacles.map((spectacle) => (
          <article class="spectacle-card">
            <div class="card-image">
              <img
                src={spectacle.data.image}
                alt={spectacle.data.title}
                loading="lazy"
              />
            </div>
            <div class="card-content">
              <h3>{spectacle.data.title}</h3>
              {spectacle.data.subtitle && (
                <p class="card-subtitle">{spectacle.data.subtitle}</p>
              )}
              <p class="card-description">{spectacle.data.description}</p>
              <div class="card-meta">
                <span><Icon name="clock" size={16} /> {spectacle.data.duration}</span>
                <span><Icon name="users" size={16} /> {spectacle.data.audience}</span>
              </div>
              <a href={`/spectacles/${spectacle.slug}`} class="btn btn-primary">En savoir plus</a>
            </div>
          </article>
        ))}
      </div>

      <div class="section-cta">
        <a href="/spectacles" class="btn btn-secondary">Voir tous nos spectacles</a>
      </div>
    </div>
  </section>

  <!-- Prochains événements (chargés depuis Google Sheets) -->
  <section class="events-section" id="events-section" style="display:none">
    <div class="container">
      <h2 class="section-title">Prochaines Dates</h2>
      <p class="section-subtitle">Venez nous voir en tournée !</p>

      <div id="home-events" class="events-grid"></div>

      <div class="section-cta">
        <a href="/tournee" class="btn btn-primary">Voir tout le calendrier</a>
      </div>
    </div>
  </section>

  <!-- Appel à l'action final -->
  <section class="cta-section">
    <div class="container">
      <h2>Envie de découvrir nos spectacles ?</h2>
      <p>Contactez-nous pour organiser une représentation dans votre ville !</p>
      <a href="/contact" class="btn btn-primary btn-large">Nous contacter</a>
    </div>
  </section>
</Layout>

<script define:vars={{ SHEET_CSV_URL }}>
  // Échappement HTML pour éviter les injections XSS
  function escapeHTML(str) {
    if (!str) return '';
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  }

  function parseLine(line) {
    const result = [];
    let current = '';
    let inQuotes = false;
    for (const char of line) {
      if (char === '"') { inQuotes = !inQuotes; }
      else if (char === ',' && !inQuotes) { result.push(current); current = ''; }
      else { current += char; }
    }
    result.push(current);
    return result;
  }

  function parseCSV(text) {
    const lines = text.trim().split('\n');
    const headers = parseLine(lines[0]).map(h => h.trim());
    return lines.slice(1)
      .map(line => {
        const values = parseLine(line);
        const obj = {};
        headers.forEach((h, i) => obj[h] = (values[i] || '').trim());
        return obj;
      })
      .filter(row => row['Date'] && row['Spectacle']);
  }

  function parseDate(dateStr) {
    if (!dateStr) return new Date(0);
    if (dateStr.includes('/')) {
      const parts = dateStr.split('/');
      return new Date(parts[2], parts[1] - 1, parts[0]);
    }
    return new Date(dateStr);
  }

  // Icônes SVG inline
  const svgAttrs = 'xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"';
  const iconPin = `<svg ${svgAttrs}><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>`;
  const iconClock = `<svg ${svgAttrs}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>`;

  async function loadHomeEvents() {
    try {
      const response = await fetch(SHEET_CSV_URL);
      if (!response.ok) return;
      const csv = await response.text();
      const events = parseCSV(csv);

      const today = new Date();
      today.setHours(0, 0, 0, 0);

      const upcoming = events
        .filter(e => parseDate(e['Date']) >= today)
        .sort((a, b) => parseDate(a['Date']) - parseDate(b['Date']))
        .slice(0, 3);

      if (upcoming.length === 0) return;

      const container = document.getElementById('home-events');
      container.innerHTML = upcoming.map(event => {
        const date = parseDate(event['Date']);
        const day = date.toLocaleDateString('fr-FR', { day: '2-digit' });
        const month = date.toLocaleDateString('fr-FR', { month: 'short' });
        let html = `
          <article class="event-card">
            <div class="event-date">
              <span class="date-day">${day}</span>
              <span class="date-month">${month}</span>
            </div>
            <div class="event-details">
              <h3>${escapeHTML(event['Spectacle'])}</h3>
              <p class="event-venue">${iconPin} ${escapeHTML(event['Lieu'])}, ${escapeHTML(event['Ville'])}</p>
              <p class="event-time">${iconClock} ${escapeHTML(event['Heure'])}</p>`;
        if (event['Lien billetterie']) {
          const url = escapeHTML(event['Lien billetterie']);
          html += `<a href="${url}" target="_blank" rel="noopener" class="btn-link">Réserver \u2192</a>`;
        }
        html += `</div></article>`;
        return html;
      }).join('');

      document.getElementById('events-section').style.display = '';
    } catch (error) {
      console.error('Erreur chargement événements:', error);
    }
  }

  loadHomeEvents();
</script>

<style>
  /* Hero Section - Design théâtral avec overlay dégradé */
  .hero {
    position: relative;
    height: 85vh;
    min-height: 650px;
    background: linear-gradient(135deg, rgba(35, 61, 76, 0.95) 0%, rgba(0, 0, 0, 0.85) 100%),
                url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 800"><defs><linearGradient id="g" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:%231E3A8A"/><stop offset="100%" style="stop-color:%230F172A"/></linearGradient></defs><rect width="1200" height="800" fill="url(%23g)"/></svg>');
    background-size: cover;
    background-position: center;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    color: white;
    overflow: hidden;
  }

  /* Motifs abstraits cosmiques (pas d'étoiles génériques) */
  .hero::before {
    content: '';
    position: absolute;
    width: 600px;
    height: 600px;
    background: radial-gradient(circle, rgba(253, 128, 46, 0.15) 0%, transparent 70%);
    border-radius: 50%;
    top: -300px;
    right: -100px;
    pointer-events: none;
    animation: cosmic-float 20s ease-in-out infinite;
  }

  .hero::after {
    content: '';
    position: absolute;
    width: 400px;
    height: 400px;
    background: radial-gradient(circle, rgba(253, 128, 46, 0.1) 0%, transparent 70%);
    border-radius: 50%;
    bottom: -200px;
    left: -100px;
    pointer-events: none;
    animation: cosmic-float 15s ease-in-out infinite reverse;
  }

  @keyframes cosmic-float {
    0%, 100% { transform: translate(0, 0) scale(1); }
    33% { transform: translate(30px, -30px) scale(1.1); }
    66% { transform: translate(-30px, 30px) scale(0.9); }
  }

  .hero-content {
    position: relative;
    z-index: 2;
    max-width: 900px;
    padding: 3rem;
  }

  .hero h1 {
    font-size: clamp(3rem, 6vw, 5.5rem);
    font-weight: 900;
    font-style: italic;
    margin-bottom: 1.5rem;
    color: white;
    text-shadow: 3px 3px 12px rgba(0, 0, 0, 0.5);
    letter-spacing: -0.03em;
    line-height: 1.1;
  }

  .hero-subtitle {
    font-size: clamp(1.15rem, 2.5vw, 1.5rem);
    margin-bottom: 3rem;
    opacity: 0.95;
    line-height: 1.6;
    font-weight: 400;
    letter-spacing: 0.02em;
  }

  .hero-cta {
    display: flex;
    gap: 1.5rem;
    justify-content: center;
    flex-wrap: wrap;
  }

  /* Actualité mise en avant - Design organique élégant */
  .news-featured {
    background: linear-gradient(180deg, var(--color-light-bg) 0%, white 100%);
    padding: var(--spacing-lg) 0;
    margin-top: -80px;
    position: relative;
    z-index: 10;
  }

  .news-card {
    background-color: white;
    border-radius: var(--radius-xl);
    padding: 3rem;
    box-shadow: var(--shadow-lg);
    display: flex;
    gap: 2.5rem;
    align-items: start;
    border: 1px solid rgba(35, 61, 76, 0.08);
    transition: all 0.4s ease;
    position: relative;
    overflow: hidden;
  }

  .news-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 5px;
    height: 100%;
    background: linear-gradient(180deg, var(--color-secondary), var(--color-primary));
  }

  .news-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
  }

  .news-icon {
    font-size: 3.5rem;
    flex-shrink: 0;
  }

  .news-content h2 {
    margin-bottom: 0.75rem;
    color: var(--color-primary);
    font-family: var(--font-heading);
    font-style: italic;
  }

  .news-date {
    font-size: 0.95rem;
    color: #6B7280;
    margin-bottom: 1.25rem;
    letter-spacing: 0.02em;
  }

  .btn-link {
    color: var(--color-secondary);
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 1.25rem;
    transition: all 0.3s ease;
  }

  .btn-link:hover {
    color: var(--color-primary);
    transform: translateX(5px);
  }

  /* Sections communes - Espaces généreux */
  .spectacles-section,
  .events-section {
    padding: var(--spacing-xl) 0;
    position: relative;
  }

  .section-title {
    text-align: center;
    font-size: clamp(2.5rem, 4vw, 3.5rem);
    margin-bottom: 1rem;
    color: var(--color-primary);
    font-family: var(--font-heading);
    font-style: italic;
    font-weight: 700;
  }

  .section-subtitle {
    text-align: center;
    font-size: 1.25rem;
    color: #6B7280;
    margin-bottom: var(--spacing-lg);
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
  }

  /* Spectacles Grid - Cartes élégantes */
  .spectacles-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 3rem;
    margin-bottom: 3rem;
  }

  .spectacle-card {
    background-color: white;
    border-radius: var(--radius-lg);
    overflow: hidden;
    box-shadow: var(--shadow-md);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    border: 1px solid rgba(35, 61, 76, 0.08);
  }

  .spectacle-card:hover {
    transform: translateY(-8px);
    box-shadow: var(--shadow-lg);
  }

  .card-image {
    aspect-ratio: 16 / 11;
    overflow: hidden;
    background: linear-gradient(135deg, var(--color-primary), #1a3340);
    position: relative;
  }

  .card-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.6s ease;
  }

  .spectacle-card:hover .card-image img {
    transform: scale(1.08);
  }

  .card-content {
    padding: 2rem;
  }

  .card-content h3 {
    margin-bottom: 0.75rem;
    color: var(--color-primary);
    font-family: var(--font-heading);
    font-size: 1.75rem;
  }

  .card-subtitle {
    font-style: italic;
    color: #6B7280;
    margin-bottom: 1.25rem;
  }

  .card-description {
    margin-bottom: 1.5rem;
    line-height: 1.7;
    color: var(--color-text);
  }

  .card-meta {
    display: flex;
    gap: 1.5rem;
    font-size: 0.95rem;
    color: #6B7280;
    margin-bottom: 1.75rem;
    padding: 1rem;
    background-color: var(--color-light-bg);
    border-radius: var(--radius-md);
  }

  /* Events Section - Background texturé */
  .events-section {
    background: linear-gradient(135deg, var(--color-light-bg) 0%, white 100%);
    position: relative;
  }

  .events-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-image:
      linear-gradient(rgba(35, 61, 76, 0.02) 1px, transparent 1px),
      linear-gradient(90deg, rgba(35, 61, 76, 0.02) 1px, transparent 1px);
    background-size: 30px 30px;
    pointer-events: none;
  }

  .events-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2.5rem;
    position: relative;
  }

  .event-card {
    background-color: white;
    border-radius: var(--radius-lg);
    padding: 2rem;
    box-shadow: var(--shadow-sm);
    display: flex;
    gap: 2rem;
    transition: all 0.3s ease;
    border: 1px solid rgba(35, 61, 76, 0.08);
  }

  .event-card:hover {
    box-shadow: var(--shadow-md);
    transform: translateY(-3px);
  }

  .event-date {
    flex-shrink: 0;
    width: 85px;
    height: 85px;
    background: linear-gradient(135deg, var(--color-secondary) 0%, #e06a1a 100%);
    color: white;
    border-radius: var(--radius-md);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    box-shadow: var(--shadow-sm);
  }

  .date-day {
    font-size: 2.25rem;
    font-weight: 700;
    line-height: 1;
    font-family: var(--font-heading);
  }

  .date-month {
    font-size: 0.95rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-top: 0.25rem;
  }

  .event-details h3 {
    margin-bottom: 0.75rem;
    font-size: 1.35rem;
    color: var(--color-primary);
  }

  .event-venue,
  .event-time {
    font-size: 0.95rem;
    color: #6B7280;
    margin-bottom: 0.5rem;
  }

  /* CTA Section - Dégradé dramatique */
  .cta-section {
    background: linear-gradient(135deg, var(--color-primary) 0%, #1a3340 100%);
    color: white;
    padding: var(--spacing-xl) 0;
    text-align: center;
    position: relative;
    overflow: hidden;
  }

  .cta-section::before {
    content: '';
    position: absolute;
    width: 500px;
    height: 500px;
    background: radial-gradient(circle, rgba(253, 128, 46, 0.2) 0%, transparent 70%);
    border-radius: 50%;
    top: -250px;
    right: -100px;
    animation: cosmic-float 20s ease-in-out infinite;
  }

  .cta-section h2 {
    color: white;
    font-size: clamp(2.5rem, 4vw, 3.5rem);
    margin-bottom: 1.5rem;
    position: relative;
  }

  .cta-section p {
    font-size: 1.25rem;
    margin-bottom: 2.5rem;
    opacity: 0.95;
    position: relative;
  }

  .section-cta {
    text-align: center;
    margin-top: 3rem;
  }

  /* Responsive mobile-first */
  @media (max-width: 768px) {
    .news-card {
      flex-direction: column;
      padding: 2rem;
    }

    .news-icon {
      font-size: 2.5rem;
    }

    .spectacles-grid,
    .events-grid {
      grid-template-columns: 1fr;
    }

    .event-card {
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

    .section-title {
      font-size: 2rem;
    }
  }
</style>
